---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const entries = await getCollection('archive');
const blogEntries = await getCollection('blogs');
const toIsoDate = (value: Date) => value.toISOString().slice(0, 10);
const latest = [...entries]
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 7);
const latestBlogs = [...blogEntries]
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 5);

const homeDescription =
  'Romulus by Nakamoto Satoshi: research feed archive and blogs on agentic programming, machine learning, and quantitative systems.';

const websiteStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Romulus',
  alternateName: ['snakamoto404', 'Nakamoto Satoshi'],
  url: Astro.site ? Astro.site.toString() : Astro.url.origin,
  description: homeDescription
};
---

<BaseLayout title="Home | Romulus" description={homeDescription} structuredData={websiteStructuredData}>
  <section class="space-y-6">
    <div class="space-y-2">
      <h1 class="text-3xl font-semibold tracking-tight">Romulus</h1>
    </div>

    <section class="space-y-3">
      <h2 class="text-xl font-semibold tracking-tight">Research Feed</h2>
      {
        latest.length ? (
          <ul class="space-y-3">
            {latest.map((entry) => (
              <li class="panel">
                <a href={`/archive/${toIsoDate(entry.data.date)}/`} class="text-base font-semibold hover:text-accent">
                  {toIsoDate(entry.data.date)}
                </a>
                <p class="mt-2 text-sm text-foreground/85">{entry.data.summary ?? 'No summary provided.'}</p>
              </li>
            ))}
          </ul>
        ) : (
          <div class="panel">
            <p>No entries yet. Check back soon.</p>
          </div>
        )
      }
    </section>

    <section class="space-y-3">
      <h2 class="text-xl font-semibold tracking-tight">Blogs</h2>
      {
        latestBlogs.length ? (
          <ul class="space-y-3">
            {latestBlogs.map((entry) => (
              <li class="panel">
                <a href={`/blogs/${entry.slug}/`} class="text-base font-semibold hover:text-accent">
                  {entry.data.title}
                </a>
                <p class="mt-2 text-sm text-foreground/80">
                  <strong>Date:</strong> <time datetime={toIsoDate(entry.data.date)}>{toIsoDate(entry.data.date)}</time>
                </p>
                <p class="mt-2 text-sm text-foreground/85">{entry.data.summary ?? 'No summary provided.'}</p>
              </li>
            ))}
          </ul>
        ) : (
          <div class="panel">
            <p>No blog posts yet.</p>
          </div>
        )
      }
      <p class="text-sm">
        <a href="/blogs/" class="font-medium">Browse all blogs -></a>
      </p>
    </section>

    <p class="text-sm">
      <a href="/archive/" class="font-medium">Browse all entries -></a>
      &nbsp;&middot;&nbsp;
      <a href="/subscribe/" class="font-medium">Manage subscription</a>
    </p>
  </section>
</BaseLayout>
